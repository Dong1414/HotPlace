<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layouts/layout">

<th:block layout:fragment="content">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=7u0vnvduxe"></script>
<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?clientId=7u0vnvduxe&submodules=geocoder"></script>

<div th:id="app">
	<div id="map" style="width:100%;height:100%;"></div>
	
	<form id="infoForm" th:object="${reviewVO}" method="post" enctype="multipart/form-data" >
		<input type="hidden" th:name="lat" th:id="lat" />
		<input type="hidden" th:name="lng" th:id="lng" />
		<div th:replace="views/map/reviewInsert :: reviewInsert"></div>
	</form>	
</div>
<style>
#app{
	position: absolute;
    left: 0;
    top: 50px;
    bottom: 0;
    right: 0;
}

</style>

<script th:inline="javascript">
var fileCnt = 10;

var mapOptions = {
	    center: new naver.maps.LatLng(36.2290986, 128.0612096),
	    zoom: 7,
	    mapTypeControl: true,
	};	
var map = new naver.maps.Map('map', mapOptions);

//커서용 마커
var cuserMarker = new naver.maps.Marker({	    	
    map: map,
});	

var markers = new Array(); // 마커 정보를 담는 배열
var areaArr = [[${resultList}]];
if(areaArr.length > 0){
	for (var i = 0; i < areaArr.length; i++) {
		// 지역을 담은 배열의 길이만큼 for문으로 마커와 정보창을 채워주자 !
	    var marker = new naver.maps.Marker({	    	
	        map: map,
	        title: areaArr[i].title,
			clickable: true,
			draggable: false,
	        position: new naver.maps.LatLng(areaArr[i].lat , areaArr[i].lng), // 지역구의 위도 경도 넣기
	        icon: {
	        	content: '<img src="/file/getImage?attachFileId='+ areaArr[i].attachFileId +'" alt="" style="margin: 0px; padding: 0px; border: 0px solid transparent; display: block; max-width: none; max-height: none; -webkit-user-select: none; position: absolute; width: 50px; height: 52px; left: 0px; top: 0px; border: solid deepskyblue; border-radius: 20px;" onerror="this.src=\'/images/noImage.png\'">',
	            size: new naver.maps.Size(50, 52),
	        },
	        seq: areaArr[i].id
	    });
	    markers.push(marker); // 생성한 마커를 배열에 담는다.
	}
}
function getClickHandler(lat, lng) {
	
    return function(e) {  // 마커를 클릭하는 부분
    	$.ajax({
            type: "get",
            url: '/map/getReview.do?lat=' + encodeURI(lat) + "&lng=" + encodeURI(lng),
            cache: false,
            contentType: false,
            processData: false,        
            dataType: "json"
        }).done(function (result) {
        	for(var i = 0; i < result.length; i++){
        		fnViewClear();
        		$("#title").val(result[i].title);
        		$("#review").val(result[i].review);
        		$("#addressInfo").val(result[i].address);
        		$('input:radio[name="rating"][value="'+result[i].rating+'"]').prop('checked', true);
        		if(result[i].attachFileMasterId == '' || result[i].attachFileMasterId == null){
        			$('#fileList').text('등록된 사진이 없습니다.');	
        		}
        	}
        })
        .fail(function() {
        	alert('등록 실패 하였습니다.');
        })
	}
}

for (var i=0, ii=markers.length; i<ii; i++) {
	naver.maps.Event.addListener(markers[i], 'click', getClickHandler(markers[i].position._lat, markers[i].position._lng));// 클릭한 마커 핸들러 
	
}

const drawStar = (target) => {
    document.querySelector(`.star span`).style.width = `${target.value * 20}%`;
}
function fnViewClear(){
	$('#infoForm')[0].reset();
}

//마커,데이터 세팅
function fnInitialization(data){
	for (var i = 0, len = markers.length; i < len; i++) {
		markers[i].setMap(null);
	}
	
	areaArr = data;
	if(areaArr.length > 0){
		for (var i = 0; i < areaArr.length; i++) {
			// 지역을 담은 배열의 길이만큼 for문으로 마커와 정보창을 채워주자 !

		    var marker = new naver.maps.Marker({	    	
		        map: map,
		        position: new naver.maps.LatLng(areaArr[i].lat , areaArr[i].lng), // 지역구의 위도 경도 넣기
		        icon: {
		        	content: '<img src="/file/getImage?attachFileId='+ areaArr[i].attachFileId +'" alt="" style="margin: 0px; padding: 0px; border: 0px solid transparent; display: block; max-width: none; max-height: none; -webkit-user-select: none; position: absolute; width: 50px; height: 52px; left: 0px; top: 0px; border: solid deepskyblue; border-radius: 20px;" onerror="this.src=\'/images/noImage.png\'">',
		            size: new naver.maps.Size(50, 52),
		        },
		        seq: areaArr[i].id
		    });
		    
			 markers.push(marker); // 생성한 마커를 배열에 담는다.
		}
	}
}

//위도 경도 (lat, lng)
naver.maps.Event.addListener(map, 'click', function(e) {
	cuserMarker.setPosition(e.latlng);
    naver.maps.Service.reverseGeocode({
        location: new naver.maps.LatLng(e.coord._lat, e.coord._lng),
    }, function(status, response) {
        if (status !== naver.maps.Service.Status.OK) {
            return alert('Something wrong!');
        }

        var result = response.result, // 검색 결과의 컨테이너
         	items = result.items; // 검색 결과의 배열
         	
        if(items.length < 1){
        	$('#addressInfo').val(items[1].address); //도로명주
        }else if(items.length == 1){
        	$('#addressInfo').val(items[0].address); //지번주소
        }else{
        	
        }
        
    });
    $('#lat').val(e.coord._lat);
    $('#lng').val(e.coord._lng);
});


//등록
function saveReview(){
	if(!confirm('등록하시겠습니까?')){
		return false;
	}
	// console.log($('input[name=rating]:checked').val()); 
	// $("#resultDiv").replaceWith(result); 
    var formData = new FormData($('#infoForm')[0]);
	$.ajax({
        type: "post",
        url: '/map/saveReview.do',
        cache: false,
        contentType: false,
        processData: false,        
        data: formData,
    }).done(function (data) {
    	alert("등록되었습니다.");
    	//등록 후 조회데이터로 오버레이 초기화
        fnInitialization(data);
    })
    .fail(function() {
    	alert('등록 실패 하였습니다.');
    })
    
}

//파일 유효검증
$("#attachFileIds").change(function (e) {
	var fileInfo = this.files;
	var maxCnt = 6;
	
	if (fileInfo.length > 10) {
		alert('최대 10개까지 업로드 할 수 있습니다.');
		return false;
	}
	
	$('.fileList').text('');
	var fileListHt = "<ul class='fileLine'>";
	for(var i = 0; i < fileInfo.length; i++){
		fileListHt += "<li id='file"+i+"'>" + fileInfo[i].name + "  <i class='fa-solid fa-xmark' onclick='fnFileSelDel(" + i + ");'></i></li>";
	}
	fileListHt += "</ul>";
	$("#fileList").append(fileListHt);

	$("#attachFileIds").css("display", "none"); 
	
	fileCnt -= fileInfo.length;
	
	
});

// 파일 업로드 개별취소
function fnFileSelDel(fileNum){
	//선택된 파일 삭제
	delete $('#attachFileIds')[0].files[fileNum];
	
	//리스트 삭제
    $('#file'+fileNum).remove();
    
	//등록 가능한 파일 갯수
    fileCnt++;
    
	//등록된 파일 없을시 활성화
    if(fileCnt == 10){
    	$("#attachFileIds").css("display", "block");
    	$('.fileList').text('사진은 10개까지 등록 가능합니다.');
    }
}

$(document).ready(function(){
	
});


</script>
</th:block>
</html>